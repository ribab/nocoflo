# Story 1.3: Refactor Authentication and Layout Components

## Epic Context
**Epic:** Epic 1: Component Architecture Foundation  
**Epic Goal:** Establish proper component separation and base interfaces to enable plugin development

## Story Details
**Priority:** High  
**Effort:** Medium  
**Dependencies:** Story 1.1 (Create Component Directory Structure)

## User Story
As a developer,
I want to extract authentication logic and create reusable layout components,
so that we have consistent UI patterns and secure authentication across the application.

## Acceptance Criteria
1. Extract authentication logic to components/common/auth.py
2. Create components/layout/header.py and components/layout/navigation.py
3. Implement consistent login page design matching main application
4. Create reusable layout components for consistent UI
5. Login page uses same design template as rest of application

## Integration Verification
- Login page matches main application design patterns
- Authentication flow remains secure and functional
- Layout components are reusable across different pages

## Technical Requirements

### Authentication Component
```python
# src/components/common/auth.py
from typing import Optional, Dict
import bcrypt
import sqlite3
from nicegui import ui, app
import metadata

class AuthManager:
    def __init__(self):
        self.current_user = None
    
    def verify_password(self, password: str, hash: str) -> bool:
        """Verify password against hash"""
        return bcrypt.checkpw(password.encode(), hash.encode())
    
    def login(self, email: str, password: str) -> bool:
        """Authenticate user and set session"""
        user = metadata.get_user_by_email(email)
        if user and self.verify_password(password, user['password_hash']):
            self.current_user = user
            for k in list(app.storage.user):
                del app.storage.user[k]
            for k, v in user.items():
                app.storage.user[k] = v
            return True
        return False
    
    def logout(self):
        """Clear user session"""
        self.current_user = None
        for k in list(app.storage.user):
            del app.storage.user[k]
    
    def get_current_user(self) -> Optional[Dict]:
        """Get current authenticated user"""
        return self.current_user or app.storage.user.get('id')
    
    def require_auth(self, redirect_to: str = '/login'):
        """Decorator to require authentication"""
        if not self.get_current_user():
            ui.navigate.to(redirect_to)
            return False
        return True
```

### Header Component
```python
# src/components/layout/header.py
from nicegui import ui
from typing import Optional, Callable

class Header:
    def __init__(self, title: str = "Nocoflo", on_logout: Optional[Callable] = None):
        self.title = title
        self.on_logout = on_logout
    
    def render(self):
        """Render the header component"""
        with ui.header().classes('bg-primary text-white'):
            with ui.row().classes('w-full items-center justify-between'):
                ui.label(self.title).classes('text-xl font-bold')
                
                with ui.row().classes('items-center gap-4'):
                    # User menu
                    with ui.menu().classes('bg-white text-black'):
                        ui.menu_item('Profile', on_click=lambda: None)
                        ui.menu_item('Settings', on_click=lambda: None)
                        ui.separator()
                        ui.menu_item('Logout', on_click=self.on_logout or self._default_logout)
    
    def _default_logout(self):
        """Default logout handler"""
        from components.common.auth import AuthManager
        auth = AuthManager()
        auth.logout()
        ui.navigate.to('/login')
```

### Navigation Component
```python
# src/components/layout/navigation.py
from nicegui import ui
from typing import List, Dict, Callable
import metadata

class Navigation:
    def __init__(self, on_table_select: Optional[Callable] = None):
        self.on_table_select = on_table_select
    
    def render(self):
        """Render the navigation component"""
        with ui.left_drawer().classes('bg-gray-100'):
            ui.label('Tables').classes('text-lg font-bold mb-4')
            
            # Get user's accessible tables
            tables = self.get_user_tables()
            
            for table in tables:
                ui.button(
                    table['display_name'],
                    on_click=lambda t=table: self._handle_table_click(t)
                ).classes('w-full text-left mb-2')
    
    def get_user_tables(self) -> List[Dict]:
        """Get tables accessible to current user"""
        if not app.storage.user:
            return []
        
        user_id = app.storage.user['id']
        return metadata.get_user_tables(user_id)
    
    def _handle_table_click(self, table: Dict):
        """Handle table selection"""
        if self.on_table_select:
            self.on_table_select(table)
        else:
            ui.navigate.to(f'/table/{table["id"]}')
```

### Enhanced Login Page
```python
# src/pages/login.py (updated)
from nicegui import ui, app
from components.common.auth import AuthManager
from components.layout.header import Header

@ui.page('/login')
def login():
    """Enhanced login page with consistent design"""
    auth = AuthManager()
    
    # Use consistent header
    header = Header(title="Nocoflo - Login")
    header.render()
    
    with ui.card().classes('mx-auto mt-8 p-8 max-w-md'):
        ui.label('üîê Login to Nocoflo').classes('text-2xl mb-6 text-center')
        
        with ui.column().classes('w-full gap-4'):
            email = ui.input('Email', placeholder='Enter your email').classes('w-full')
            password = ui.input('Password', password=True, placeholder='Enter your password').classes('w-full')
            
            def do_login():
                if not email.value or not password.value:
                    ui.notify('‚ùå Please fill in all fields', type='negative')
                    return
                
                if auth.login(email.value, password.value):
                    ui.notify('‚úÖ Login successful', type='positive')
                    ui.navigate.to('/')
                else:
                    ui.notify('‚ùå Invalid credentials', type='negative')
            
            ui.button('Login', on_click=do_login).classes('w-full bg-blue-500 text-white')
            
            ui.separator().classes('my-4')
            ui.link('üìù Don\'t have an account? Contact admin for invite', '/').classes('text-blue-500 text-center')
```

## Implementation Tasks

### Task 1: Create Authentication Component
- [ ] Create `src/components/common/auth.py` with AuthManager class
- [ ] Implement password verification functionality
- [ ] Implement login/logout functionality
- [ ] Add session management
- [ ] Create authentication decorator

### Task 2: Create Header Component
- [ ] Create `src/components/layout/header.py` with Header class
- [ ] Implement consistent header design
- [ ] Add user menu functionality
- [ ] Integrate logout functionality
- [ ] Make header responsive

### Task 3: Create Navigation Component
- [ ] Create `src/components/layout/navigation.py` with Navigation class
- [ ] Implement table navigation
- [ ] Add user table filtering
- [ ] Implement navigation callbacks
- [ ] Make navigation responsive

### Task 4: Update Login Page
- [ ] Redesign login page to match main application
- [ ] Use consistent color schemes and typography
- [ ] Implement proper form validation
- [ ] Add loading states and user feedback
- [ ] Ensure responsive design

### Task 5: Update Existing Pages
- [ ] Update all pages to use new layout components
- [ ] Integrate authentication checks
- [ ] Ensure consistent navigation
- [ ] Test all user flows

### Task 6: Testing
- [ ] Test authentication flow
- [ ] Test layout components
- [ ] Test responsive design
- [ ] Verify security functionality

## Definition of Done
- [ ] Authentication logic is extracted to reusable component
- [ ] Header and navigation components are created
- [ ] Login page matches main application design
- [ ] All layout components are reusable
- [ ] Authentication flow remains secure
- [ ] All existing functionality works with new components
- [ ] Responsive design is implemented
- [ ] Tests cover new components

## Risk Assessment
**Risk:** Refactoring authentication may introduce security issues
**Mitigation:** Comprehensive testing of authentication flows, gradual rollout

## Dependencies
- Story 1.1: Create Component Directory Structure (must be completed first)

## Next Stories
- Story 2.1: Create Chart View Plugin
- Story 4.1: Enhance Login Page Design 