# Story 4.3: Enhance Table View UI

## Epic Context
**Epic:** Epic 4: UI/UX Enhancement and Consistency  
**Epic Goal:** Ensure consistent and polished user experience across all components

## Story Details
**Priority:** Medium  
**Effort:** Medium  
**Dependencies:** Story 1.1 (Create Component Directory Structure)

## User Story
As a user,
I want an enhanced table view with better visual feedback and improved usability,
so that I can work with data more efficiently and with a better user experience.

## Acceptance Criteria
1. Improve table view layout and spacing
2. Add better visual feedback for editing operations
3. Implement improved error handling and user feedback
4. Add keyboard shortcuts for common operations
5. Enhance accessibility features

## Integration Verification
- Table view remains functional and performant
- User experience is improved without breaking existing functionality
- Accessibility standards are met

## Technical Requirements

### Enhanced Table View Component
```python
# src/components/views/enhanced_table_view.py
from nicegui import ui
from typing import Dict, List, Any, Optional
from components.grid import create_grid
import metadata

class EnhancedTableView:
    def __init__(self, table_id: int):
        self.table_id = table_id
        self.current_data = []
        self.current_columns = []
        self.editing_cell = None
        self.selected_rows = []
        self.keyboard_shortcuts = {}
        self.error_messages = []
    
    def render(self):
        """Render enhanced table view"""
        # Header with table info and actions
        self._render_table_header()
        
        # Toolbar with actions
        self._render_toolbar()
        
        # Enhanced grid with improved UX
        self._render_enhanced_grid()
        
        # Status bar with feedback
        self._render_status_bar()
        
        # Error handling overlay
        self._render_error_overlay()
    
    def _render_table_header(self):
        """Render table header with info and actions"""
        with ui.card().classes('w-full mb-4'):
            with ui.row().classes('w-full items-center justify-between'):
                # Table info
                with ui.column().classes('flex-1'):
                    table_info = self._get_table_info()
                    ui.label(table_info['display_name']).classes('text-xl font-bold')
                    ui.label(f"{len(self.current_data)} rows • {len(self.current_columns)} columns").classes('text-sm text-gray-600')
                
                # Quick actions
                with ui.row().classes('gap-2'):
                    ui.button('Refresh', icon='refresh', on_click=lambda: self._refresh_data())
                    ui.button('Export', icon='download', on_click=lambda: self._export_data())
                    ui.button('Settings', icon='settings', on_click=lambda: self._show_settings())
    
    def _render_toolbar(self):
        """Render toolbar with enhanced actions"""
        with ui.card().classes('w-full mb-4'):
            with ui.row().classes('w-full items-center gap-4'):
                # Search functionality
                search_input = ui.input('Search...', icon='search').classes('flex-1')
                search_input.on('input', lambda e: self._filter_data(e.value))
                
                # View controls
                with ui.row().classes('gap-2'):
                    ui.button('Table', icon='table_chart', on_click=lambda: self._switch_view('table'))
                    ui.button('Chart', icon='bar_chart', on_click=lambda: self._switch_view('chart'))
                    ui.button('Form', icon='edit_note', on_click=lambda: self._switch_view('form'))
                
                # Bulk actions
                with ui.menu().classes('bg-white text-black'):
                    ui.menu_item('Delete Selected', icon='delete', on_click=lambda: self._delete_selected())
                    ui.menu_item('Export Selected', icon='download', on_click=lambda: self._export_selected())
                    ui.menu_item('Copy Selected', icon='content_copy', on_click=lambda: self._copy_selected())
    
    def _render_enhanced_grid(self):
        """Render enhanced grid with improved UX"""
        # Enhanced grid configuration
        grid_config = {
            'enable_editing': True,
            'enable_selection': True,
            'enable_sorting': True,
            'enable_filtering': True,
            'enable_resizing': True,
            'enable_export': True,
            'grid_height': '600px',
            'theme': 'ag-theme-alpine-dark',
            'row_selection': 'multiple',
            'suppress_row_click_selection': False,
            'suppress_cell_selection': False,
            'enable_range_selection': True,
            'enable_fill_handle': True,
            'enable_undo_redo': True,
        }
        
        # Enhanced event handlers
        event_handlers = {
            'on_cell_edit': self._handle_cell_edit,
            'on_row_select': self._handle_row_select,
            'on_row_double_click': self._handle_row_double_click,
            'on_grid_ready': self._handle_grid_ready,
            'on_cell_click': self._handle_cell_click,
            'on_key_press': self._handle_key_press,
        }
        
        # Create enhanced grid
        self.grid = create_grid(
            data=self.current_data,
            column_defs=self._get_enhanced_column_defs(),
            **grid_config,
            **event_handlers
        )
    
    def _get_enhanced_column_defs(self) -> List[Dict]:
        """Get enhanced column definitions with better UX"""
        column_defs = []
        
        for col in self.current_columns:
            col_def = {
                'field': col,
                'headerName': col.replace('_', ' ').title(),
                'sortable': True,
                'filter': True,
                'resizable': True,
                'editable': self._is_column_editable(col),
                'cellStyle': self._get_cell_style(col),
                'cellRenderer': self._get_cell_renderer(col),
                'cellEditor': self._get_cell_editor(col),
                'width': self._get_column_width(col),
            }
            
            # Add validation
            if self._has_validation(col):
                col_def['cellValidator'] = self._get_cell_validator(col)
            
            column_defs.append(col_def)
        
        return column_defs
    
    def _get_cell_style(self, column: str) -> Dict:
        """Get cell styling based on column type"""
        if column.endswith('_id'):
            return {'backgroundColor': '#f0f9ff', 'fontWeight': 'bold'}
        elif column in ['created_at', 'updated_at']:
            return {'backgroundColor': '#fef3c7', 'fontSize': '0.875rem'}
        elif column == 'status':
            return {'backgroundColor': '#dcfce7'}
        else:
            return {}
    
    def _get_cell_renderer(self, column: str) -> str:
        """Get appropriate cell renderer"""
        if column == 'status':
            return 'agSelectCellRenderer'
        elif column.endswith('_date'):
            return 'agDateCellRenderer'
        elif column.endswith('_amount'):
            return 'agNumberCellRenderer'
        else:
            return 'agTextCellRenderer'
    
    def _get_cell_editor(self, column: str) -> str:
        """Get appropriate cell editor"""
        if column == 'status':
            return 'agSelectCellEditor'
        elif column.endswith('_date'):
            return 'agDateCellEditor'
        elif column.endswith('_amount'):
            return 'agNumberCellEditor'
        else:
            return 'agTextCellEditor'
    
    def _handle_cell_edit(self, event):
        """Handle cell editing with enhanced feedback"""
        try:
            # Validate the edit
            if not self._validate_cell_edit(event):
                ui.notify('❌ Invalid value', type='negative')
                return False
            
            # Show saving indicator
            self._show_saving_indicator(event.colId, event.rowIndex)
            
            # Perform the update
            success = self._update_cell_data(event)
            
            if success:
                ui.notify('✅ Cell updated successfully', type='positive')
                self._hide_saving_indicator()
            else:
                ui.notify('❌ Failed to update cell', type='negative')
                self._hide_saving_indicator()
            
            return success
            
        except Exception as e:
            ui.notify(f'❌ Error updating cell: {str(e)}', type='negative')
            self._hide_saving_indicator()
            return False
    
    def _handle_row_select(self, event):
        """Handle row selection with visual feedback"""
        if event.args.get('selected'):
            self.selected_rows.append(event.args['data'])
        else:
            self.selected_rows = [row for row in self.selected_rows if row != event.args['data']]
        
        # Update selection count in status bar
        self._update_selection_count()
    
    def _handle_row_double_click(self, event):
        """Handle row double-click for detailed view"""
        row_data = event.args['data']
        self._show_row_details(row_data)
    
    def _handle_key_press(self, event):
        """Handle keyboard shortcuts"""
        key = event.args.get('key')
        
        shortcuts = {
            'Delete': self._delete_selected,
            'Ctrl+c': self._copy_selected,
            'Ctrl+v': self._paste_data,
            'Ctrl+z': self._undo_action,
            'Ctrl+y': self._redo_action,
            'Ctrl+f': lambda: self._focus_search(),
            'Escape': self._clear_selection,
        }
        
        if key in shortcuts:
            shortcuts[key]()
    
    def _show_saving_indicator(self, col_id: str, row_index: int):
        """Show saving indicator for cell"""
        # Implementation for showing saving indicator
        pass
    
    def _hide_saving_indicator(self):
        """Hide saving indicator"""
        # Implementation for hiding saving indicator
        pass
    
    def _validate_cell_edit(self, event) -> bool:
        """Validate cell edit"""
        value = event.args.get('newValue')
        column = event.args.get('colId')
        
        # Basic validation
        if value is None or value == '':
            return True  # Allow empty values
        
        # Type-specific validation
        if column.endswith('_id'):
            return str(value).isdigit()
        elif column.endswith('_amount'):
            try:
                float(value)
                return True
            except:
                return False
        elif column.endswith('_date'):
            # Date validation
            return True
        
        return True
    
    def _update_cell_data(self, event) -> bool:
        """Update cell data in database"""
        try:
            # Update in database
            success = metadata.update_cell(
                self.table_id,
                event.args.get('data', {}).get('id'),
                event.args.get('colId'),
                event.args.get('newValue')
            )
            
            if success:
                # Update local data
                row_index = event.args.get('rowIndex')
                if row_index < len(self.current_data):
                    self.current_data[row_index][event.args.get('colId')] = event.args.get('newValue')
            
            return success
            
        except Exception as e:
            self.error_messages.append(f"Error updating cell: {str(e)}")
            return False
    
    def _render_status_bar(self):
        """Render status bar with feedback"""
        with ui.row().classes('w-full justify-between items-center p-2 bg-gray-100 rounded'):
            # Selection info
            selection_info = ui.label(f"{len(self.selected_rows)} rows selected")
            
            # Error count
            if self.error_messages:
                error_count = ui.label(f"{len(self.error_messages)} errors", color='red')
            
            # Last action
            last_action = ui.label("Ready")
            
            # Keyboard shortcuts help
            with ui.button('⌨️', icon='keyboard').classes('text-sm'):
                with ui.menu():
                    ui.menu_item('Delete: Delete key')
                    ui.menu_item('Copy: Ctrl+C')
                    ui.menu_item('Paste: Ctrl+V')
                    ui.menu_item('Undo: Ctrl+Z')
                    ui.menu_item('Redo: Ctrl+Y')
                    ui.menu_item('Search: Ctrl+F')
                    ui.menu_item('Clear: Escape')
    
    def _render_error_overlay(self):
        """Render error handling overlay"""
        if self.error_messages:
            with ui.overlay().classes('bg-red-50 border border-red-200 rounded p-4'):
                ui.label('Errors').classes('font-bold text-red-800 mb-2')
                for error in self.error_messages[-5:]:  # Show last 5 errors
                    ui.label(f"• {error}").classes('text-red-700 text-sm')
                
                with ui.row().classes('mt-2'):
                    ui.button('Clear Errors', on_click=lambda: self._clear_errors())
                    ui.button('Retry', on_click=lambda: self._retry_failed_operations())
    
    def _clear_errors(self):
        """Clear error messages"""
        self.error_messages = []
    
    def _retry_failed_operations(self):
        """Retry failed operations"""
        # Implementation for retrying failed operations
        pass
    
    def _get_table_info(self) -> Dict:
        """Get table information"""
        # Implementation to get table metadata
        return {
            'display_name': 'Sample Table',
            'row_count': len(self.current_data),
            'column_count': len(self.current_columns)
        }
    
    def _refresh_data(self):
        """Refresh table data"""
        # Implementation to refresh data
        pass
    
    def _export_data(self):
        """Export table data"""
        # Implementation to export data
        pass
    
    def _show_settings(self):
        """Show table settings"""
        # Implementation to show settings
        pass
    
    def _filter_data(self, search_term: str):
        """Filter table data"""
        # Implementation to filter data
        pass
    
    def _switch_view(self, view_type: str):
        """Switch to different view type"""
        # Implementation to switch views
        pass
    
    def _delete_selected(self):
        """Delete selected rows"""
        # Implementation to delete selected rows
        pass
    
    def _export_selected(self):
        """Export selected rows"""
        # Implementation to export selected rows
        pass
    
    def _copy_selected(self):
        """Copy selected rows"""
        # Implementation to copy selected rows
        pass
    
    def _show_row_details(self, row_data: Dict):
        """Show detailed view of row"""
        # Implementation to show row details
        pass
    
    def _update_selection_count(self):
        """Update selection count display"""
        # Implementation to update selection count
        pass
    
    def _focus_search(self):
        """Focus search input"""
        # Implementation to focus search
        pass
    
    def _clear_selection(self):
        """Clear current selection"""
        # Implementation to clear selection
        pass
```

## Implementation Tasks

### Task 1: Create Enhanced Table View Component
- [ ] Create `src/components/views/enhanced_table_view.py`
- [ ] Implement enhanced grid configuration
- [ ] Add improved event handlers
- [ ] Create status bar component

### Task 2: Add Visual Feedback Features
- [ ] Implement saving indicators
- [ ] Add error handling overlay
- [ ] Create selection feedback
- [ ] Add progress indicators

### Task 3: Implement Keyboard Shortcuts
- [ ] Add keyboard event handling
- [ ] Implement common shortcuts
- [ ] Create shortcuts help menu
- [ ] Add accessibility features

### Task 4: Enhance Cell Editing
- [ ] Improve cell validation
- [ ] Add cell styling
- [ ] Implement custom cell renderers
- [ ] Add cell editors for different types

### Task 5: Add Toolbar Features
- [ ] Implement search functionality
- [ ] Add view switching controls
- [ ] Create bulk action menu
- [ ] Add export functionality

### Task 6: Improve Error Handling
- [ ] Create error overlay system
- [ ] Implement error retry mechanism
- [ ] Add error logging
- [ ] Create user-friendly error messages

### Task 7: Testing
- [ ] Test enhanced grid functionality
- [ ] Test keyboard shortcuts
- [ ] Test error handling
- [ ] Test accessibility features

## Definition of Done
- [ ] Table view layout and spacing are improved
- [ ] Better visual feedback for editing operations is implemented
- [ ] Improved error handling and user feedback is added
- [ ] Keyboard shortcuts for common operations are implemented
- [ ] Accessibility features are enhanced
- [ ] Table view remains functional and performant
- [ ] User experience is improved without breaking existing functionality
- [ ] Accessibility standards are met
- [ ] Tests cover enhanced table view functionality

## Risk Assessment
**Risk:** Enhanced features may impact performance
**Mitigation:** Performance monitoring, lazy loading, and optimization

## Dependencies
- Story 1.1: Create Component Directory Structure (must be completed first)

## Next Stories
- Story 5.1: Implement Performance Monitoring
- Story 5.3: Security and Error Handling 