# Story 3.2: Implement Database Configuration System

## Epic Context
**Epic:** Epic 3: Plugin Management and Configuration  
**Epic Goal:** Provide user-friendly interfaces for managing plugins and configurations

## Story Details
**Priority:** High  
**Effort:** Medium  
**Dependencies:** Story 1.2 (Implement Plugin Manager with pluggy)

## User Story
As a developer,
I want to implement a configurable database backend system,
so that users can choose different database systems while maintaining SQLite as the default.

## Acceptance Criteria
1. Create database configuration interface
2. SQLite remains the default and primary database
3. Support for PostgreSQL and MySQL through plugins
4. Database connection testing and validation
5. Migration tools for switching between databases

## Integration Verification
- SQLite continues to work as the default database
- Database switching doesn't break existing functionality
- All existing data remains accessible after configuration changes

## Technical Requirements

### Database Configuration Interface
```python
# src/pages/admin/database_configuration.py
from nicegui import ui, app
from typing import Dict, List, Optional
from components.common.auth import AuthManager
from components.datasources.base_datasource import BaseDatasource

@ui.page('/admin/database')
def database_configuration():
    """Database configuration interface for administrators"""
    auth = AuthManager()
    
    # Require admin authentication
    if not auth.require_auth('/login') or not auth.is_admin():
        ui.navigate.to('/login')
        return
    
    # Header
    with ui.header().classes('bg-primary text-white'):
        ui.label('Database Configuration').classes('text-xl font-bold')
    
    # Main content
    with ui.column().classes('w-full p-6'):
        # Current database status
        with ui.card().classes('w-full mb-6'):
            ui.label('Current Database Status').classes('text-lg font-semibold mb-4')
            
            current_db = get_current_database_config()
            
            with ui.row().classes('w-full gap-4'):
                ui.card().classes('flex-1 p-4 bg-blue-50'):
                    ui.label(current_db['type']).classes('text-xl font-bold text-blue-600')
                    ui.label('Database Type').classes('text-sm text-gray-600')
                
                ui.card().classes('flex-1 p-4 bg-green-50'):
                    ui.label('Connected' if current_db['status'] == 'connected' else 'Disconnected').classes('text-xl font-bold text-green-600')
                    ui.label('Connection Status').classes('text-sm text-gray-600')
                
                ui.card().classes('flex-1 p-4 bg-yellow-50'):
                    ui.label(str(current_db['table_count'])).classes('text-xl font-bold text-yellow-600')
                    ui.label('Tables').classes('text-sm text-gray-600')
        
        # Database configuration
        with ui.card().classes('w-full mb-6'):
            ui.label('Database Configuration').classes('text-lg font-semibold mb-4')
            
            # Database type selector
            with ui.row().classes('w-full items-center mb-4'):
                ui.label('Database Type:').classes('mr-4')
                db_types = ['sqlite', 'postgresql', 'mysql']
                db_type_select = ui.select(
                    db_types,
                    value=current_db['type'],
                    on_change=lambda e: update_config_form(e.value)
                )
            
            # Configuration form
            config_form = ui.column().classes('w-full gap-4')
            
            # SQLite configuration
            with config_form:
                sqlite_config = ui.column().classes('w-full gap-4')
                with sqlite_config:
                    ui.label('SQLite Configuration').classes('font-medium')
                    db_path = ui.input('Database Path', value='nocoflo.db').classes('w-full')
                    ui.button('Test Connection', on_click=lambda: test_sqlite_connection(db_path.value))
            
            # PostgreSQL configuration
            with config_form:
                postgres_config = ui.column().classes('w-full gap-4')
                with postgres_config:
                    ui.label('PostgreSQL Configuration').classes('font-medium')
                    pg_host = ui.input('Host', value='localhost').classes('w-full')
                    pg_port = ui.number('Port', value=5432).classes('w-full')
                    pg_database = ui.input('Database', value='nocoflo').classes('w-full')
                    pg_username = ui.input('Username').classes('w-full')
                    pg_password = ui.input('Password', password=True).classes('w-full')
                    ui.button('Test Connection', on_click=lambda: test_postgres_connection())
            
            # MySQL configuration
            with config_form:
                mysql_config = ui.column().classes('w-full gap-4')
                with mysql_config:
                    ui.label('MySQL Configuration').classes('font-medium')
                    mysql_host = ui.input('Host', value='localhost').classes('w-full')
                    mysql_port = ui.number('Port', value=3306).classes('w-full')
                    mysql_database = ui.input('Database', value='nocoflo').classes('w-full')
                    mysql_username = ui.input('Username').classes('w-full')
                    mysql_password = ui.input('Password', password=True).classes('w-full')
                    ui.button('Test Connection', on_click=lambda: test_mysql_connection())
            
            # Action buttons
            with ui.row().classes('w-full justify-end gap-2 mt-6'):
                ui.button('Save Configuration', on_click=lambda: save_database_config())
                ui.button('Migrate Data', on_click=lambda: migrate_database())
                ui.button('Reset to Default', on_click=lambda: reset_to_sqlite())
        
        # Migration status
        with ui.card().classes('w-full'):
            ui.label('Migration Status').classes('text-lg font-semibold mb-4')
            
            migration_status = ui.label('No migration in progress')
            migration_progress = ui.linear_progress().classes('w-full')
            
            with ui.row().classes('w-full justify-end gap-2'):
                ui.button('Start Migration', on_click=lambda: start_migration())
                ui.button('Cancel Migration', on_click=lambda: cancel_migration())
    
    def update_config_form(db_type: str):
        """Update configuration form based on database type"""
        # Show/hide appropriate configuration sections
        if db_type == 'sqlite':
            sqlite_config.classes('block')
            postgres_config.classes('hidden')
            mysql_config.classes('hidden')
        elif db_type == 'postgresql':
            sqlite_config.classes('hidden')
            postgres_config.classes('block')
            mysql_config.classes('hidden')
        elif db_type == 'mysql':
            sqlite_config.classes('hidden')
            postgres_config.classes('hidden')
            mysql_config.classes('block')
    
    def test_sqlite_connection(db_path: str):
        """Test SQLite connection"""
        try:
            import sqlite3
            conn = sqlite3.connect(db_path)
            conn.close()
            ui.notify('âœ… SQLite connection successful', type='positive')
        except Exception as e:
            ui.notify(f'âŒ SQLite connection failed: {str(e)}', type='negative')
    
    def test_postgres_connection():
        """Test PostgreSQL connection"""
        try:
            import psycopg2
            conn = psycopg2.connect(
                host=pg_host.value,
                port=pg_port.value,
                database=pg_database.value,
                user=pg_username.value,
                password=pg_password.value
            )
            conn.close()
            ui.notify('âœ… PostgreSQL connection successful', type='positive')
        except Exception as e:
            ui.notify(f'âŒ PostgreSQL connection failed: {str(e)}', type='negative')
    
    def test_mysql_connection():
        """Test MySQL connection"""
        try:
            import mysql.connector
            conn = mysql.connector.connect(
                host=mysql_host.value,
                port=mysql_port.value,
                database=mysql_database.value,
                user=mysql_username.value,
                password=mysql_password.value
            )
            conn.close()
            ui.notify('âœ… MySQL connection successful', type='positive')
        except Exception as e:
            ui.notify(f'âŒ MySQL connection failed: {str(e)}', type='negative')
    
    def save_database_config():
        """Save database configuration"""
        try:
            config = {
                'type': db_type_select.value,
                'sqlite': {'path': db_path.value},
                'postgresql': {
                    'host': pg_host.value,
                    'port': pg_port.value,
                    'database': pg_database.value,
                    'username': pg_username.value,
                    'password': pg_password.value
                },
                'mysql': {
                    'host': mysql_host.value,
                    'port': mysql_port.value,
                    'database': mysql_database.value,
                    'username': mysql_username.value,
                    'password': mysql_password.value
                }
            }
            
            save_database_config_to_metadata(config)
            ui.notify('âœ… Database configuration saved successfully', type='positive')
            
        except Exception as e:
            ui.notify(f'âŒ Failed to save configuration: {str(e)}', type='negative')
    
    def migrate_database():
        """Migrate data between databases"""
        try:
            # Implementation for data migration
            ui.notify('ðŸ”„ Starting database migration...', type='info')
            # Migration logic here
            ui.notify('âœ… Database migration completed successfully', type='positive')
        except Exception as e:
            ui.notify(f'âŒ Database migration failed: {str(e)}', type='negative')
    
    def reset_to_sqlite():
        """Reset to SQLite default"""
        try:
            reset_database_to_sqlite()
            ui.notify('âœ… Reset to SQLite default successfully', type='positive')
        except Exception as e:
            ui.notify(f'âŒ Failed to reset to SQLite: {str(e)}', type='negative')
```

### Database Configuration Manager
```python
# src/components/admin/database_manager.py
from typing import Dict, List, Optional
import sqlite3
import json
from pathlib import Path

class DatabaseManager:
    def __init__(self):
        self.config_file = Path('config/database.json')
        self.current_config = self.load_config()
    
    def load_config(self) -> Dict:
        """Load database configuration from file"""
        if self.config_file.exists():
            with open(self.config_file, 'r') as f:
                return json.load(f)
        else:
            # Default SQLite configuration
            return {
                'type': 'sqlite',
                'sqlite': {'path': 'nocoflo.db'},
                'postgresql': {},
                'mysql': {}
            }
    
    def save_config(self, config: Dict):
        """Save database configuration to file"""
        self.config_file.parent.mkdir(exist_ok=True)
        with open(self.config_file, 'w') as f:
            json.dump(config, f, indent=2)
        self.current_config = config
    
    def get_current_database_config(self) -> Dict:
        """Get current database configuration"""
        return self.current_config
    
    def test_connection(self, db_type: str, config: Dict) -> bool:
        """Test database connection"""
        try:
            if db_type == 'sqlite':
                return self._test_sqlite_connection(config)
            elif db_type == 'postgresql':
                return self._test_postgres_connection(config)
            elif db_type == 'mysql':
                return self._test_mysql_connection(config)
            else:
                return False
        except Exception:
            return False
    
    def _test_sqlite_connection(self, config: Dict) -> bool:
        """Test SQLite connection"""
        try:
            import sqlite3
            db_path = config.get('path', 'nocoflo.db')
            conn = sqlite3.connect(db_path)
            conn.close()
            return True
        except Exception:
            return False
    
    def _test_postgres_connection(self, config: Dict) -> bool:
        """Test PostgreSQL connection"""
        try:
            import psycopg2
            conn = psycopg2.connect(
                host=config.get('host', 'localhost'),
                port=config.get('port', 5432),
                database=config.get('database', 'nocoflo'),
                user=config.get('username'),
                password=config.get('password')
            )
            conn.close()
            return True
        except Exception:
            return False
    
    def _test_mysql_connection(self, config: Dict) -> bool:
        """Test MySQL connection"""
        try:
            import mysql.connector
            conn = mysql.connector.connect(
                host=config.get('host', 'localhost'),
                port=config.get('port', 3306),
                database=config.get('database', 'nocoflo'),
                user=config.get('username'),
                password=config.get('password')
            )
            conn.close()
            return True
        except Exception:
            return False
    
    def migrate_data(self, source_config: Dict, target_config: Dict) -> bool:
        """Migrate data between databases"""
        try:
            # Implementation for data migration
            # This would involve:
            # 1. Reading data from source database
            # 2. Transforming data if needed
            # 3. Writing data to target database
            # 4. Updating configuration
            return True
        except Exception:
            return False
```

## Implementation Tasks

### Task 1: Create Database Configuration Interface
- [ ] Create `src/pages/admin/database_configuration.py`
- [ ] Implement database type selection
- [ ] Add configuration forms for each database type
- [ ] Implement connection testing

### Task 2: Create Database Manager
- [ ] Create `src/components/admin/database_manager.py`
- [ ] Implement configuration loading/saving
- [ ] Add connection testing functionality
- [ ] Implement data migration logic

### Task 3: Add Database Plugins
- [ ] Create PostgreSQL datasource plugin
- [ ] Create MySQL datasource plugin
- [ ] Integrate with plugin system
- [ ] Add database-specific features

### Task 4: Implement Migration Tools
- [ ] Create data migration utilities
- [ ] Add schema migration support
- [ ] Implement rollback functionality
- [ ] Add migration progress tracking

### Task 5: Update Metadata System
- [ ] Extend metadata tables for database config
- [ ] Add database configuration storage
- [ ] Update existing queries for multi-database support
- [ ] Add database switching logic

### Task 6: Testing
- [ ] Test database configuration interface
- [ ] Test connection functionality
- [ ] Test data migration
- [ ] Test database switching

## Definition of Done
- [ ] Database configuration interface is created
- [ ] SQLite remains the default and primary database
- [ ] Support for PostgreSQL and MySQL is implemented
- [ ] Database connection testing and validation works
- [ ] Migration tools are provided for switching between databases
- [ ] SQLite continues to work as the default database
- [ ] Database switching doesn't break existing functionality
- [ ] All existing data remains accessible after configuration changes
- [ ] Tests cover database configuration functionality

## Risk Assessment
**Risk:** Database migration may cause data loss
**Mitigation:** Comprehensive backup procedures, dry-run migrations, rollback capabilities

## Dependencies
- Story 1.2: Implement Plugin Manager with pluggy (must be completed first)

## Next Stories
- Story 3.3: Create Plugin Development Kit
- Story 4.2: Implement Consistent Navigation System 