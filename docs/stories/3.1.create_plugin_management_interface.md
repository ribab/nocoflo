# Story 3.1: Create Plugin Management Interface

## Epic Context
**Epic:** Epic 3: Plugin Management and Configuration  
**Epic Goal:** Provide user-friendly interfaces for managing plugins and configurations

## Story Details
**Priority:** High  
**Effort:** Medium  
**Dependencies:** Story 1.2 (Implement Plugin Manager with pluggy)

## User Story
As an administrator,
I want to manage plugins through a web interface,
so that I can enable/disable plugins and configure their settings.

## Acceptance Criteria
1. Create admin interface for viewing installed plugins
2. Implement enable/disable functionality for plugins
3. Add plugin health monitoring and error reporting
4. Create plugin configuration interface for datasource settings
5. Plugin changes take effect without application restart

## Integration Verification
- Plugin management doesn't interfere with existing functionality
- Plugin changes take effect without application restart
- Plugin errors are handled gracefully without breaking the application

## Technical Requirements

### Plugin Management Interface
```python
# src/pages/admin/plugin_management.py
from nicegui import ui, app
from typing import Dict, List
from components.common.auth import AuthManager
from plugins.plugin_manager import PluginManager

@ui.page('/admin/plugins')
def plugin_management():
    """Plugin management interface for administrators"""
    auth = AuthManager()
    
    # Require admin authentication
    if not auth.require_auth('/login') or not auth.is_admin():
        ui.navigate.to('/login')
        return
    
    plugin_manager = PluginManager()
    
    # Header
    with ui.header().classes('bg-primary text-white'):
        ui.label('Plugin Management').classes('text-xl font-bold')
    
    # Main content
    with ui.column().classes('w-full p-6'):
        # Plugin overview
        with ui.card().classes('w-full mb-6'):
            ui.label('Plugin Overview').classes('text-lg font-semibold mb-4')
            
            # Plugin statistics
            with ui.row().classes('w-full gap-4'):
                total_plugins = len(plugin_manager.get_all_plugins())
                enabled_plugins = len(plugin_manager.get_enabled_plugins())
                
                ui.card().classes('flex-1 p-4 bg-blue-50'):
                    ui.label(f'{total_plugins}').classes('text-2xl font-bold text-blue-600')
                    ui.label('Total Plugins').classes('text-sm text-gray-600')
                
                ui.card().classes('flex-1 p-4 bg-green-50'):
                    ui.label(f'{enabled_plugins}').classes('text-2xl font-bold text-green-600')
                    ui.label('Enabled Plugins').classes('text-sm text-gray-600')
                
                ui.card().classes('flex-1 p-4 bg-yellow-50'):
                    ui.label(f'{total_plugins - enabled_plugins}').classes('text-2xl font-bold text-yellow-600')
                    ui.label('Disabled Plugins').classes('text-sm text-gray-600')
        
        # Plugin list
        with ui.card().classes('w-full'):
            ui.label('Installed Plugins').classes('text-lg font-semibold mb-4')
            
            # Plugin table
            with ui.table().classes('w-full').props('rows-per-page-options=[10, 25, 50]'):
                ui.table_column('Name', 'name')
                ui.table_column('Type', 'type')
                ui.table_column('Status', 'status')
                ui.table_column('Version', 'version')
                ui.table_column('Actions', 'actions')
                
                plugins = plugin_manager.get_all_plugins()
                for plugin in plugins:
                    with ui.table_row():
                        ui.table_cell(plugin['name'])
                        ui.table_cell(plugin['type'])
                        
                        # Status indicator
                        status_color = 'green' if plugin['enabled'] else 'gray'
                        ui.table_cell(
                            ui.badge(plugin['status'], color=status_color)
                        )
                        
                        ui.table_cell(plugin['version'])
                        
                        # Action buttons
                        with ui.table_cell():
                            with ui.row().classes('gap-2'):
                                if plugin['enabled']:
                                    ui.button(
                                        'Disable',
                                        on_click=lambda p=plugin: disable_plugin(p),
                                        color='warning'
                                    ).classes('text-xs')
                                else:
                                    ui.button(
                                        'Enable',
                                        on_click=lambda p=plugin: enable_plugin(p),
                                        color='positive'
                                    ).classes('text-xs')
                                
                                ui.button(
                                    'Configure',
                                    on_click=lambda p=plugin: configure_plugin(p),
                                    color='primary'
                                ).classes('text-xs')
                                
                                ui.button(
                                    'Info',
                                    on_click=lambda p=plugin: show_plugin_info(p),
                                    color='secondary'
                                ).classes('text-xs')
        
        # Plugin configuration dialog
        with ui.dialog() as config_dialog, ui.card():
            ui.label('Plugin Configuration').classes('text-lg font-semibold mb-4')
            
            plugin_name = ui.label()
            plugin_config = ui.textarea('Configuration (JSON)').classes('w-full h-32')
            
            with ui.row().classes('w-full justify-end gap-2'):
                ui.button('Cancel', on_click=config_dialog.close)
                ui.button('Save', on_click=lambda: save_plugin_config())
        
        # Plugin info dialog
        with ui.dialog() as info_dialog, ui.card():
            ui.label('Plugin Information').classes('text-lg font-semibold mb-4')
            
            info_content = ui.column()
            
            with ui.row().classes('w-full justify-end'):
                ui.button('Close', on_click=info_dialog.close)
    
    def enable_plugin(plugin: Dict):
        """Enable a plugin"""
        try:
            plugin_manager.enable_plugin(plugin['name'])
            ui.notify(f'✅ Plugin {plugin["name"]} enabled successfully', type='positive')
            # Refresh the page to show updated status
            ui.timer(1.0, lambda: ui.refresh(), once=True)
        except Exception as e:
            ui.notify(f'❌ Failed to enable plugin: {str(e)}', type='negative')
    
    def disable_plugin(plugin: Dict):
        """Disable a plugin"""
        try:
            plugin_manager.disable_plugin(plugin['name'])
            ui.notify(f'✅ Plugin {plugin["name"]} disabled successfully', type='positive')
            # Refresh the page to show updated status
            ui.timer(1.0, lambda: ui.refresh(), once=True)
        except Exception as e:
            ui.notify(f'❌ Failed to disable plugin: {str(e)}', type='negative')
    
    def configure_plugin(plugin: Dict):
        """Configure a plugin"""
        plugin_name.text = plugin['name']
        plugin_config.value = plugin.get('config', '{}')
        config_dialog.open()
    
    def save_plugin_config():
        """Save plugin configuration"""
        try:
            import json
            config = json.loads(plugin_config.value)
            plugin_manager.update_plugin_config(plugin_name.text, config)
            ui.notify('✅ Plugin configuration saved successfully', type='positive')
            config_dialog.close()
        except json.JSONDecodeError:
            ui.notify('❌ Invalid JSON configuration', type='negative')
        except Exception as e:
            ui.notify(f'❌ Failed to save configuration: {str(e)}', type='negative')
    
    def show_plugin_info(plugin: Dict):
        """Show detailed plugin information"""
        info_content.clear()
        
        with info_content:
            ui.label(f"Name: {plugin['name']}").classes('font-medium')
            ui.label(f"Type: {plugin['type']}")
            ui.label(f"Version: {plugin['version']}")
            ui.label(f"Status: {plugin['status']}")
            ui.label(f"Description: {plugin.get('description', 'No description available')}")
            
            if plugin.get('author'):
                ui.label(f"Author: {plugin['author']}")
            
            if plugin.get('dependencies'):
                ui.label("Dependencies:")
                for dep in plugin['dependencies']:
                    ui.label(f"  - {dep}")
        
        info_dialog.open()
```

### Plugin Health Monitoring
```python
# src/components/admin/plugin_monitor.py
from typing import Dict, List
import time
from plugins.plugin_manager import PluginManager

class PluginMonitor:
    def __init__(self, plugin_manager: PluginManager):
        self.plugin_manager = plugin_manager
        self.health_checks = {}
    
    def check_plugin_health(self, plugin_name: str) -> Dict:
        """Check health of a specific plugin"""
        try:
            plugin = self.plugin_manager.get_plugin(plugin_name)
            if not plugin:
                return {'status': 'error', 'message': 'Plugin not found'}
            
            # Basic health checks
            health_status = {
                'status': 'healthy',
                'last_check': time.time(),
                'errors': []
            }
            
            # Check if plugin can be loaded
            if not self.plugin_manager.can_load_plugin(plugin_name):
                health_status['status'] = 'error'
                health_status['errors'].append('Plugin cannot be loaded')
            
            # Check for configuration errors
            config_errors = self.plugin_manager.validate_plugin_config(plugin_name)
            if config_errors:
                health_status['status'] = 'warning'
                health_status['errors'].extend(config_errors)
            
            # Check for dependency issues
            dependency_errors = self.plugin_manager.check_plugin_dependencies(plugin_name)
            if dependency_errors:
                health_status['status'] = 'error'
                health_status['errors'].extend(dependency_errors)
            
            self.health_checks[plugin_name] = health_status
            return health_status
            
        except Exception as e:
            return {
                'status': 'error',
                'message': f'Health check failed: {str(e)}',
                'last_check': time.time(),
                'errors': [str(e)]
            }
    
    def get_all_plugin_health(self) -> Dict[str, Dict]:
        """Get health status for all plugins"""
        plugins = self.plugin_manager.get_all_plugins()
        health_status = {}
        
        for plugin in plugins:
            health_status[plugin['name']] = self.check_plugin_health(plugin['name'])
        
        return health_status
    
    def get_health_summary(self) -> Dict:
        """Get summary of plugin health"""
        health_status = self.get_all_plugin_health()
        
        summary = {
            'total': len(health_status),
            'healthy': 0,
            'warning': 0,
            'error': 0
        }
        
        for status in health_status.values():
            summary[status['status']] += 1
        
        return summary
```

## Implementation Tasks

### Task 1: Create Plugin Management Page
- [ ] Create `src/pages/admin/plugin_management.py`
- [ ] Implement plugin listing interface
- [ ] Add enable/disable functionality
- [ ] Create plugin configuration dialogs
- [ ] Add plugin information display

### Task 2: Implement Plugin Health Monitoring
- [ ] Create `src/components/admin/plugin_monitor.py`
- [ ] Implement health check functionality
- [ ] Add dependency checking
- [ ] Create health status reporting
- [ ] Add error handling

### Task 3: Add Plugin Configuration Interface
- [ ] Create JSON-based configuration editor
- [ ] Add configuration validation
- [ ] Implement configuration persistence
- [ ] Add configuration templates

### Task 4: Implement Plugin Actions
- [ ] Add enable/disable functionality
- [ ] Implement plugin reloading
- [ ] Add plugin uninstall capability
- [ ] Create plugin installation interface

### Task 5: Add Error Handling
- [ ] Implement graceful error handling
- [ ] Add error reporting and logging
- [ ] Create fallback mechanisms
- [ ] Add user-friendly error messages

### Task 6: Testing
- [ ] Test plugin management functionality
- [ ] Test health monitoring
- [ ] Test configuration management
- [ ] Test error handling

## Definition of Done
- [ ] Admin interface for viewing installed plugins is created
- [ ] Enable/disable functionality for plugins is implemented
- [ ] Plugin health monitoring and error reporting is added
- [ ] Plugin configuration interface is created
- [ ] Plugin changes take effect without application restart
- [ ] Plugin management doesn't interfere with existing functionality
- [ ] Plugin errors are handled gracefully
- [ ] Tests cover plugin management functionality

## Risk Assessment
**Risk:** Plugin management may introduce security vulnerabilities
**Mitigation:** Proper authentication, input validation, and sandboxing

## Dependencies
- Story 1.2: Implement Plugin Manager with pluggy (must be completed first)

## Next Stories
- Story 3.2: Implement Database Configuration System
- Story 3.3: Create Plugin Development Kit 