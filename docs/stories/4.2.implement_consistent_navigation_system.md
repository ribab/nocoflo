# Story 4.2: Implement Consistent Navigation System

## Epic Context
**Epic:** Epic 4: UI/UX Enhancement and Consistency  
**Epic Goal:** Ensure consistent and polished user experience across all components

## Story Details
**Priority:** Medium  
**Effort:** Medium  
**Dependencies:** Story 1.3 (Refactor Authentication and Layout Components)

## User Story
As a user,
I want consistent navigation across all pages,
so that I can easily navigate between different parts of the application.

## Acceptance Criteria
1. Create consistent navigation component
2. Implement breadcrumb navigation
3. Add proper page transitions and loading states
4. Create responsive navigation for mobile devices
5. Implement proper active state indicators

## Integration Verification
- Navigation works consistently across all pages
- Mobile navigation is functional and intuitive
- Page transitions are smooth and professional

## Technical Requirements

### Consistent Navigation Component
```python
# src/components/layout/navigation.py
from nicegui import ui
from typing import List, Dict, Callable, Optional
import metadata

class Navigation:
    def __init__(self, on_table_select: Optional[Callable] = None):
        self.on_table_select = on_table_select
        self.current_page = None
        self.breadcrumbs = []
    
    def render(self):
        """Render the navigation component"""
        with ui.left_drawer().classes('bg-gray-100'):
            # Logo and app title
            with ui.column().classes('w-full items-center mb-6 p-4'):
                ui.icon('dashboard').classes('text-3xl text-blue-500 mb-2')
                ui.label('Nocoflo').classes('text-xl font-bold text-gray-800')
            
            # Main navigation menu
            self._render_main_menu()
            
            # Table navigation
            self._render_table_navigation()
            
            # User section
            self._render_user_section()
    
    def _render_main_menu(self):
        """Render main navigation menu"""
        with ui.column().classes('w-full mb-6'):
            ui.label('Navigation').classes('text-sm font-semibold text-gray-600 mb-2 px-4')
            
            menu_items = [
                {'icon': 'home', 'label': 'Dashboard', 'route': '/', 'active': self.current_page == '/'},
                {'icon': 'table_chart', 'label': 'Tables', 'route': '/tables', 'active': self.current_page == '/tables'},
                {'icon': 'settings', 'label': 'Settings', 'route': '/settings', 'active': self.current_page == '/settings'},
                {'icon': 'admin_panel_settings', 'label': 'Admin', 'route': '/admin', 'active': self.current_page.startswith('/admin')},
            ]
            
            for item in menu_items:
                self._render_menu_item(item)
    
    def _render_menu_item(self, item: Dict):
        """Render individual menu item"""
        classes = 'w-full text-left px-4 py-2 rounded-md mb-1 transition-colors'
        
        if item['active']:
            classes += ' bg-blue-100 text-blue-700'
        else:
            classes += ' text-gray-700 hover:bg-gray-200'
        
        with ui.button(
            item['label'],
            icon=item['icon'],
            on_click=lambda r=item['route']: ui.navigate.to(r)
        ).classes(classes):
            pass
    
    def _render_table_navigation(self):
        """Render table navigation"""
        if not app.storage.user:
            return
        
        with ui.column().classes('w-full mb-6'):
            ui.label('Tables').classes('text-sm font-semibold text-gray-600 mb-2 px-4')
            
            # Get user's accessible tables
            tables = self.get_user_tables()
            
            if not tables:
                ui.label('No tables available').classes('text-sm text-gray-500 px-4')
                return
            
            for table in tables:
                self._render_table_item(table)
    
    def _render_table_item(self, table: Dict):
        """Render individual table item"""
        is_active = self.current_page == f'/table/{table["id"]}'
        
        classes = 'w-full text-left px-4 py-2 rounded-md mb-1 transition-colors'
        
        if is_active:
            classes += ' bg-blue-100 text-blue-700'
        else:
            classes += ' text-gray-700 hover:bg-gray-200'
        
        with ui.button(
            table['display_name'],
            icon='table_rows',
            on_click=lambda t=table: self._handle_table_click(t)
        ).classes(classes):
            pass
    
    def _render_user_section(self):
        """Render user section"""
        if not app.storage.user:
            return
        
        with ui.column().classes('w-full border-t pt-4'):
            ui.label('User').classes('text-sm font-semibold text-gray-600 mb-2 px-4')
            
            user = app.storage.user
            
            # User info
            with ui.row().classes('w-full px-4 mb-2'):
                ui.avatar(user.get('name', 'User')[:1]).classes('mr-2')
                ui.column().classes('flex-1'):
                    ui.label(user.get('name', 'User')).classes('text-sm font-medium')
                    ui.label(user.get('email', '')).classes('text-xs text-gray-500')
            
            # User menu
            with ui.menu().classes('bg-white text-black'):
                ui.menu_item('Profile', icon='person', on_click=lambda: ui.navigate.to('/profile'))
                ui.menu_item('Settings', icon='settings', on_click=lambda: ui.navigate.to('/settings'))
                ui.separator()
                ui.menu_item('Logout', icon='logout', on_click=self._logout)
    
    def get_user_tables(self) -> List[Dict]:
        """Get tables accessible to current user"""
        if not app.storage.user:
            return []
        
        user_id = app.storage.user['id']
        return metadata.get_user_tables(user_id)
    
    def _handle_table_click(self, table: Dict):
        """Handle table selection"""
        if self.on_table_select:
            self.on_table_select(table)
        else:
            ui.navigate.to(f'/table/{table["id"]}')
    
    def _logout(self):
        """Handle user logout"""
        from components.common.auth import AuthManager
        auth = AuthManager()
        auth.logout()
        ui.navigate.to('/login')
    
    def set_current_page(self, page: str):
        """Set current page for active state"""
        self.current_page = page
    
    def set_breadcrumbs(self, breadcrumbs: List[Dict]):
        """Set breadcrumbs for current page"""
        self.breadcrumbs = breadcrumbs
```

### Breadcrumb Navigation Component
```python
# src/components/layout/breadcrumbs.py
from nicegui import ui
from typing import List, Dict

class Breadcrumbs:
    def __init__(self, items: List[Dict] = None):
        self.items = items or []
    
    def render(self):
        """Render breadcrumb navigation"""
        if not self.items:
            return
        
        with ui.row().classes('w-full items-center mb-4'):
            for i, item in enumerate(self.items):
                # Breadcrumb item
                if i == len(self.items) - 1:
                    # Last item (current page)
                    ui.label(item['label']).classes('text-gray-900 font-medium')
                else:
                    # Link item
                    ui.link(
                        item['label'],
                        item.get('route', '#'),
                        icon=item.get('icon')
                    ).classes('text-blue-600 hover:text-blue-800')
                    
                    # Separator
                    ui.icon('chevron_right').classes('text-gray-400 mx-2')
    
    def add_item(self, label: str, route: str = None, icon: str = None):
        """Add breadcrumb item"""
        self.items.append({
            'label': label,
            'route': route,
            'icon': icon
        })
    
    def clear(self):
        """Clear breadcrumbs"""
        self.items = []
```

### Page Transition Manager
```python
# src/components/layout/page_transitions.py
from nicegui import ui
from typing import Callable, Optional

class PageTransitionManager:
    def __init__(self):
        self.loading_overlay = None
        self.transition_callback = None
    
    def show_loading(self, message: str = "Loading..."):
        """Show loading overlay"""
        if self.loading_overlay:
            self.loading_overlay.delete()
        
        self.loading_overlay = ui.overlay().classes('bg-black bg-opacity-50')
        with self.loading_overlay:
            with ui.card().classes('bg-white p-6 rounded-lg'):
                ui.spinner('dots', size='lg').classes('mb-4')
                ui.label(message).classes('text-lg')
    
    def hide_loading(self):
        """Hide loading overlay"""
        if self.loading_overlay:
            self.loading_overlay.delete()
            self.loading_overlay = None
    
    def navigate_with_transition(self, route: str, callback: Optional[Callable] = None):
        """Navigate with loading transition"""
        self.show_loading("Navigating...")
        
        def complete_navigation():
            ui.navigate.to(route)
            self.hide_loading()
            if callback:
                callback()
        
        ui.timer(0.5, complete_navigation, once=True)
    
    def set_transition_callback(self, callback: Callable):
        """Set transition callback for page changes"""
        self.transition_callback = callback
```

### Responsive Navigation
```python
# src/components/layout/responsive_navigation.py
from nicegui import ui
from typing import Dict, List

class ResponsiveNavigation:
    def __init__(self):
        self.is_mobile = False
        self.mobile_menu_open = False
    
    def render_mobile_navigation(self):
        """Render mobile-specific navigation"""
        # Mobile menu button
        with ui.button(
            icon='menu',
            on_click=lambda: self._toggle_mobile_menu()
        ).classes('lg:hidden fixed top-4 left-4 z-50 bg-white shadow-lg rounded-md p-2'):
            pass
        
        # Mobile menu overlay
        if self.mobile_menu_open:
            with ui.overlay().classes('bg-black bg-opacity-50 z-40'):
                with ui.card().classes('bg-white w-80 h-full rounded-r-lg'):
                    self._render_mobile_menu_content()
    
    def _render_mobile_menu_content(self):
        """Render mobile menu content"""
        with ui.column().classes('w-full h-full p-4'):
            # Header
            with ui.row().classes('w-full justify-between items-center mb-6'):
                ui.label('Menu').classes('text-xl font-bold')
                ui.button(
                    icon='close',
                    on_click=lambda: self._toggle_mobile_menu()
                ).classes('text-gray-500')
            
            # Navigation items
            self._render_mobile_navigation_items()
    
    def _render_mobile_navigation_items(self):
        """Render mobile navigation items"""
        # Main navigation
        with ui.column().classes('w-full mb-6'):
            ui.label('Navigation').classes('text-sm font-semibold text-gray-600 mb-2')
            
            mobile_items = [
                {'icon': 'home', 'label': 'Dashboard', 'route': '/'},
                {'icon': 'table_chart', 'label': 'Tables', 'route': '/tables'},
                {'icon': 'settings', 'label': 'Settings', 'route': '/settings'},
            ]
            
            for item in mobile_items:
                with ui.button(
                    item['label'],
                    icon=item['icon'],
                    on_click=lambda r=item['route']: self._navigate_mobile(r)
                ).classes('w-full text-left p-3 rounded-md mb-1 hover:bg-gray-100'):
                    pass
    
    def _toggle_mobile_menu(self):
        """Toggle mobile menu"""
        self.mobile_menu_open = not self.mobile_menu_open
    
    def _navigate_mobile(self, route: str):
        """Navigate from mobile menu"""
        self.mobile_menu_open = False
        ui.navigate.to(route)
    
    def check_screen_size(self):
        """Check if screen is mobile size"""
        # Implementation to detect mobile screen size
        # This would typically be done with JavaScript
        pass
```

## Implementation Tasks

### Task 1: Create Navigation Components
- [ ] Create `src/components/layout/navigation.py`
- [ ] Create `src/components/layout/breadcrumbs.py`
- [ ] Create `src/components/layout/page_transitions.py`
- [ ] Create `src/components/layout/responsive_navigation.py`

### Task 2: Implement Main Navigation
- [ ] Add main menu items
- [ ] Implement active state indicators
- [ ] Add user section
- [ ] Implement logout functionality

### Task 3: Add Table Navigation
- [ ] Implement table listing
- [ ] Add table selection
- [ ] Implement table filtering
- [ ] Add table search

### Task 4: Implement Breadcrumbs
- [ ] Create breadcrumb component
- [ ] Add breadcrumb generation logic
- [ ] Implement breadcrumb navigation
- [ ] Add breadcrumb styling

### Task 5: Add Page Transitions
- [ ] Implement loading overlays
- [ ] Add transition animations
- [ ] Create transition callbacks
- [ ] Add progress indicators

### Task 6: Implement Responsive Design
- [ ] Add mobile navigation
- [ ] Implement mobile menu
- [ ] Add touch-friendly interactions
- [ ] Test on different screen sizes

### Task 7: Testing
- [ ] Test navigation functionality
- [ ] Test mobile responsiveness
- [ ] Test page transitions
- [ ] Test breadcrumb navigation

## Definition of Done
- [ ] Consistent navigation component is created
- [ ] Breadcrumb navigation is implemented
- [ ] Page transitions and loading states are added
- [ ] Responsive navigation for mobile devices is created
- [ ] Proper active state indicators are implemented
- [ ] Navigation works consistently across all pages
- [ ] Mobile navigation is functional and intuitive
- [ ] Page transitions are smooth and professional
- [ ] Tests cover navigation functionality

## Risk Assessment
**Risk:** Navigation changes may break existing page routing
**Mitigation:** Comprehensive testing, gradual rollout, fallback navigation

## Dependencies
- Story 1.3: Refactor Authentication and Layout Components (must be completed first)

## Next Stories
- Story 4.3: Enhance Table View UI
- Story 5.1: Implement Performance Monitoring 